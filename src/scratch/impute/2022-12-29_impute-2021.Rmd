---
title: "Impute missing census years"
author: "Jon/Monica"
date: "29/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE)
```

```{r}
pacman::p_load('DBI','odbc','RODBC','dplyr','dbplyr','ggplot2','tidyverse', 'here', 'plm', 'plotly', 'stargazer', 'sjPlot', 'sjmisc', 'sjlabelled', 'naniar', 'simputation',  'randomForest', 'mice')
```

```{r}
# census_data <- readRDS("census_data.rds")
ALL_YEARS_DATA_PCT_POPCHANGE_21 %>%
  arrow::read_parquet(
     file = "../Data/ALL_YEARS_DATA_PCT_POPCHANGE_21.parquet")
```


  the TRANSLATION_MASTER_DEC_2022 only has the CENSUS 2016 DA and postal code. wait?

We can do the imputation and PCA in DA level instead of postal code region level. 

Later, we should update the pop change in other census year using R and SQL. 
S

This imputation should be done in postal code level since the langitude and latitude privode new information for imputation. 

But now it is done in DA level.





```{r}
# census_total_2021 <- ALL_YEARS_DATA_21 %>% filter(CENSUS_YEAR == 2021)
# census_total_2021 %>% glimpse()
# missing_cols_total_2021 <- miss_var_summary(CA21_DATA, show_pct = 1) 
```

Inf represents an infinite value, such as when you divide a number by 0.

 is.infinite() and is.finite().

```{r}
# check missing values
census_2021 <- ALL_YEARS_DATA_PCT_POPCHANGE_21 %>% filter(CENSUS_YEAR == 2021)


missing_cols_2021 <- miss_var_summary(census_2021, show_pct = 1) 

census_2021 %>% 
  summarise(
    across(
      .cols = everything(),
      .fns = ~sum(is.infinite(.x))
    )
  ) %>% 
  pivot_longer(
    cols = everything()
    
  ) %>% 
  filter(value >0)
```

 It is weird that 
 
name<chr> value<int>
COUPLES_CHILD_N	2			
OCC_TRADES	1			
GO_TO_WORK_7AM_9AM	1			
POP_PCT_CHANGE	27
 
 
 Should repalce those Inf with zeros?

Inf should be replaced by NA and imputed.


```{r}
census_2021 = census_2021 %>% 
  mutate(
    
    across(
      .cols = c(COUPLES_CHILD_N, OCC_TRADES, GO_TO_WORK_7AM_9AM,
                POP_PCT_CHANGE),
      .fns = ~case_when(
        is.infinite(.x) ~ NA_real_,
        T ~ .x
      )
    )
  )
```

```{r}
census_2021 %>%   
  tabyl(DA_ID ) %>%
  filter(n>1)
```
No duplicated rows

```{r}
# Random Forest Links
# http://ugrad.stat.ubc.ca/R/library/randomForest/html/rfImpute.html
# https://stefvanbuuren.name/mice/reference/mice.impute.rf.html
# http://ugrad.stat.ubc.ca/R/library/randomForest/html/rfImpute.html


# imp <- mice(census_2011, meth = "rf", ntree = 3) # takes forever

# No missing DA_ID? 
census_2021 %>% 
  filter(is.na(DA_ID))


census_2021 %>% nrow()
```

Why the impute_knn will change the DA_IA?

```{r}
# data_imputed_2021 %>% head()
```


```{r}
census_2021 %>% 
  filter(DA_ID == "59590039") %>% 
  
  head()
```
In census_2021, the DA_ID is the same as REGION_NAME

```{r}
census_2021 %>% filter(
  DA_ID != REGION_NAME
)
```



```{r}
census_2021 %>% 
  tabyl(DA_ID ) %>%
  filter(n>1)
```
‘impute’ new package 
https://bioc.ism.ac.jp/packages/3.11/bioc/manuals/impute/man/impute.pdf



```{r}
census_2021 <- as.data.frame(census_2021) %>% 
  mutate(DA_ID = as.numeric(DA_ID))
# This fixed the impute_knn issue which will change the value of original data, and creatre duplicated rows. 

test = census_2021 %>% impute_knn(
              POP_DENSITY ~
              DA_ID #+ CSD_UID+CT_UID
               
              , 
              k=2
)
# ?? why change DA_ID
# start with population
# change DA_ID to double, it stops imput_knn to change the value of DA_ID
data_imputed_2021 <- census_2021 %>% impute_knn(
              POP_DENSITY ~
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then labour force
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO ~
              POP_DENSITY +
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then labour rates
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT ~
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then education
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD ~
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then major
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES ~
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then aboriginal, reg indian, minority
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then home value and cost
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then home ownership
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then home suitable and repair
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then occupation
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then going to work time
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then age group
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then marital status
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then language
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              DA_ID 
               
              , 
              k=2
)  %>% impute_knn( # then dwelling type
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then fam size and couples with children
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then single parents
              SING_PARENT_F+
              SING_PARENT_M ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then citizens and immigrants
              CITIZEN_CAN+
              CITIZEN_NOT_CAN+
              IMMIGRANT_YES+
              IMMIGRANT_NO ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N+
              SING_PARENT_F+
              SING_PARENT_M+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then income pt 1
              INC_FAM_TOP+
              INC_FAM_BOTTOM+
              INC_FAM_DEC_10+
              INC_HHS_100K_125K+
              INC_HHS_125K_150K+
              INC_HHS_150K_PLUS+
              INC_BT_IND_MED+
              INC_BT_FAM_MED+
              INC_AT_FAM_MED+
              INC_AT_LONE_PARENT_MED+
              INC_AT_CPL_W_CHILD_MED+
              INC_BT_HHS_MED ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N+
              SING_PARENT_F+
              SING_PARENT_M+
              CITIZEN_CAN+
              CITIZEN_NOT_CAN+
              IMMIGRANT_YES+
              IMMIGRANT_NO+
              DA_ID 
               
              , 
              k=2
) %>% impute_knn( # then income pt 2
              LICO_AT_PREVALENCE+
              LIM_AT_PREVALENCE+
              INC_BT_IND_AVG+
              INC_BT_FAM_AVG+
              INC_AT_FAM_AVG+
              INC_BT_HHS_AVG+
              INC_AT_LONE_PARENT_AVG+
              INC_AT_CPL_W_CHILD_AVG ~
                
              POP_DENSITY +
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N+
              SING_PARENT_F+
              SING_PARENT_M+
              CITIZEN_CAN+
              CITIZEN_NOT_CAN+
              IMMIGRANT_YES+
              IMMIGRANT_NO+
              INC_FAM_TOP+
              INC_FAM_BOTTOM+
              INC_FAM_DEC_10+
              INC_HHS_100K_125K+
              INC_HHS_125K_150K+
              INC_HHS_150K_PLUS+
              INC_BT_IND_MED+
              INC_BT_FAM_MED+
              INC_AT_FAM_MED+
              INC_AT_LONE_PARENT_MED+
              INC_AT_CPL_W_CHILD_MED+
              INC_BT_HHS_MED+
              DA_ID 
               
              , 
              k=2
);

data_imputed_2021 = data_imputed_2021  %>% 
  impute_knn( # then commute pt 2

                  GO_TO_WORK_5AM_6AM+
                  GO_TO_WORK_6AM_7AM+
                  GO_TO_WORK_7AM_8AM+
                  GO_TO_WORK_8AM_9AM+
                  GO_TO_WORK_9AM_12PM+
                  GO_TO_WORK_12PM_4AM+
                  COMMUTE_DURATION_15M_LESS +
                  COMMUTE_DURATION_15_29M +
                  COMMUTE_DURATION_30_44M +
                  COMMUTE_DURATION_45_59M +
                  COMMUTE_DURATION_60M_OVER     ~
                
              POP_DENSITY +
                 LICO_AT_PREVALENCE+
              LIM_AT_PREVALENCE+
              INC_BT_IND_AVG+
              INC_BT_FAM_AVG+
              INC_AT_FAM_AVG+
              INC_BT_HHS_AVG+
              INC_AT_LONE_PARENT_AVG+
              INC_AT_CPL_W_CHILD_AVG+
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N+
              SING_PARENT_F+
              SING_PARENT_M+
              CITIZEN_CAN+
              CITIZEN_NOT_CAN+
              IMMIGRANT_YES+
              IMMIGRANT_NO+
              INC_FAM_TOP+
              INC_FAM_BOTTOM+
              INC_FAM_DEC_10+
              INC_HHS_100K_125K+
              INC_HHS_125K_150K+
              INC_HHS_150K_PLUS+
              INC_BT_IND_MED+
              INC_BT_FAM_MED+
              INC_AT_FAM_MED+
              INC_AT_LONE_PARENT_MED+
              INC_AT_CPL_W_CHILD_MED+
              INC_BT_HHS_MED+
              DA_ID 
               
              , 
              k=2
)
  


data_imputed_2021 = data_imputed_2021  %>% 
  impute_knn( # then commute pt 2

                AVG_AGE + MEDIAN_AGE  ~
                
              POP_DENSITY +
                   GO_TO_WORK_5AM_6AM+
                  GO_TO_WORK_6AM_7AM+
                  GO_TO_WORK_7AM_8AM+
                  GO_TO_WORK_8AM_9AM+
                  GO_TO_WORK_9AM_12PM+
                  GO_TO_WORK_12PM_4AM+
                  COMMUTE_DURATION_15M_LESS +
                  COMMUTE_DURATION_15_29M +
                  COMMUTE_DURATION_30_44M +
                  COMMUTE_DURATION_45_59M +
                  COMMUTE_DURATION_60M_OVER +
                 LICO_AT_PREVALENCE+
              LIM_AT_PREVALENCE+
              INC_BT_IND_AVG+
              INC_BT_FAM_AVG+
              INC_AT_FAM_AVG+
              INC_BT_HHS_AVG+
              INC_AT_LONE_PARENT_AVG+
              INC_AT_CPL_W_CHILD_AVG+
              IN_LAB_FORCE_YES + IN_LAB_FORCE_NO +
              LABOUR_PART_RT + LABOUR_EMPL_RT + LABOUR_UNEM_RT +
              EDUC_NONE +
              EDUC_HIGHSCH +
              EDUC_POSTSEC +
              EDUC_COLLEGE +
              EDUC_BACHELOR +
              EDUC_TRADES +
              EDUC_CRT_ABV_BACH +
              EDUC_MEDICAL +
              EDUC_MASTERS +
              EDUC_PHD +
              MAJOR_EDUC+
              MAJOR_ART_COM+
              MAJOR_HUMANITIES+
              MAJOR_SOC_SCI+
              MAJOR_BUS_MGT+
              MAJOR_PHY_SCI+
              MAJOR_MATH_COMP+
              MAJOR_ENGR+
              MAJOR_NAT_RSRC+
              MAJOR_HLTH+
              MAJOR_SERVICES+
              ABORIGINAL_YES+
              ABORIGINAL_NO+
              REG_INDIAN_YES+
              REG_INDIAN_NO+
              MINORITY_YES+
              MINORITY_NO+
              HOME_VALUE_AVG+
              HOME_VALUE_MED+
              HOME_COST_OWN+
              HOME_RENT_AVG+
              HOME_RENT_MED+
              HOME_OWN_OWN+
              HOME_OWN_RENT+
              HOME_OWN_BAND+
              HOME_SUITABLE_YES+
              HOME_SUITABLE_NO+
              REPAIRS_MINOR+
              REPAIRS_MAJOR+
              SUBSIDIZED_HOUS+
              OCC_MGMT+
              OCC_BUS_FIN_AD+
              OCC_NAT_APP_SCI+
              OCC_HLTH+
              OCC_SOCI_SERV+
              OCC_ART_CUL_REC+
              OCC_SALE_SERV+
              OCC_TRADES+
              OCC_NAT_RSRC+
              OCC_MAN_UTIL+
              GO_TO_WORK_5AM_7AM+
              GO_TO_WORK_7AM_9AM+
              GO_TO_WORK_AFTER_9AM+
              AGE_GRP_00_04+
              AGE_GRP_05_09+
              AGE_GRP_10_14+
              AGE_GRP_15_19+
              AGE_GRP_20_24+
              AGE_GRP_25_29+
              AGE_GRP_30_34+
              AGE_GRP_35_39+
              AGE_GRP_40_44+
              AGE_GRP_45_49+
              AGE_GRP_50_54+
              AGE_GRP_55_59+
              AGE_GRP_60_64+
              AGE_GRP_65_PLUS+
              MARITAL_MARR+
              MARITAL_NEVER+
              MARITAL_SEP+
              MARITAL_DIV+
              MARITAL_WID+
              LANG_KNOW_EN+
              LANG_KNOW_FR+
              LANG_KNOW_BOTH+
              LANG_KNOW_NONE+
              LANG_SPOKE_EN+
              LANG_SPOKE_FR+
              LANG_SPOKE_BOTH+
              LANG_SPOKE_NONE+
              DWELL_HOUS+
              DWELL_APT_LRG+
              DWELL_APT_SML+
              DWELL_MOVE+
              FAM_SIZE_2+
              FAM_SIZE_3+
              FAM_SIZE_4+
              FAM_SIZE_5+
              COUPLES_CHILD_Y+
              COUPLES_CHILD_N+
              SING_PARENT_F+
              SING_PARENT_M+
              CITIZEN_CAN+
              CITIZEN_NOT_CAN+
              IMMIGRANT_YES+
              IMMIGRANT_NO+
              INC_FAM_TOP+
              INC_FAM_BOTTOM+
              INC_FAM_DEC_10+
              INC_HHS_100K_125K+
              INC_HHS_125K_150K+
              INC_HHS_150K_PLUS+
              INC_BT_IND_MED+
              INC_BT_FAM_MED+
              INC_AT_FAM_MED+
              INC_AT_LONE_PARENT_MED+
              INC_AT_CPL_W_CHILD_MED+
              INC_BT_HHS_MED+
              DA_ID 
               
              , 
              k=2
)
```

```{r}
data_imputed_2021 %>% glimpse()
```


```{r}
data_imputed_2021 %>% 
 tabyl(DA_ID ) %>%
  filter(n>1)
# Why the impute_knn change the value in DA_ID?
data_imputed_2021 %>% 
 tabyl(REGION_NAME ) %>%
  filter(n>1)
data_imputed_2021 %>% 
    select(starts_with("MAJOR")) %>% 
  glimpse()
# now there are duplicated rows which must be imputed in the previous process. So there are missing DA_ID in previous dataset. 
imp_missing_cols_2021 <- miss_var_summary(data_imputed_2021, show_pct = 1) 
```


```{r}
saveRDS(data_imputed_2021, "K:/Projects/Advanced Analytics/1 Projects/2019/2019-253 Census database all years/Impute/data_imputed_knn_2021.rds")

data_imputed_2021 %>% 
  arrow::write_parquet(
    sink = "../../Data/census_da_imputed_2021.parquet",
    compression = "uncompressed")

data_imputed_2021 = 
  arrow::read_parquet(
    file = "../../Data/census_da_imputed_2021.parquet")
```


```{r}
data_imputed_2021 <- readRDS("K:/Projects/Advanced Analytics/1 Projects/2019/2019-253 Census database all years/Impute/data_imputed_knn_2021.rds")
```


```{r}
data_imputed_2021 %>% 
    summarise(
    across(
      .cols = c(INC_BT_FAM_AVG, INC_BT_FAM_MED, INC_AT_FAM_AVG, INC_AT_FAM_MED),
      .fns = ~mean(.x, na.rm = T)
    )
  )
```



1. a long postal code table: ECON_CENSUS_ALL_YRS_POSTAL_CODES_IMP
	DA_ID, 
	CSD_UID, 
	CD_UID, 
	CENSUS_YEAR, 
	POP_DENSITY, 
	AGE_GRP_00_04, 
	AGE_GRP_05_09, 
	AGE_GRP_10_14, 
	AGE_GRP_15_19, 
	AGE_GRP_20_24, 
	AGE_GRP_25_29, 
	AGE_GRP_30_34, 
	AGE_GRP_35_39, 
	AGE_GRP_40_44, 
	AGE_GRP_45_49, 
	AGE_GRP_50_54, 
	AGE_GRP_55_59, 
	AGE_GRP_60_64, 
	AGE_GRP_65_PLUS, 
	DWELL_HOUS, 
	DWELL_APT_LRG, 
	DWELL_APT_SML, 
	DWELL_MOVE, 
	MARITAL_MARR, 
	MARITAL_NEVER, 
	MARITAL_SEP, 
	MARITAL_DIV, 
	MARITAL_WID, 
	FAM_SIZE_2, 
	FAM_SIZE_3, 
	FAM_SIZE_4, 
	FAM_SIZE_5, 
	SING_PARENT_F, 
	SING_PARENT_M, 
	COUPLES_CHILD_Y, 
	COUPLES_CHILD_N, 
	INC_FAM_TOP, 
	INC_FAM_BOTTOM, 
	INC_FAM_DEC_10, 
	INC_HHS_100K_125K, 
	INC_HHS_125K_150K, 
	INC_HHS_150K_PLUS, 
	ABORIGINAL_YES, 
	ABORIGINAL_NO, 
	REG_INDIAN_YES, 
	REG_INDIAN_NO, 
	MINORITY_YES, 
	MINORITY_NO, 
	CITIZEN_CAN, 
	CITIZEN_NOT_CAN, 
	IMMIGRANT_YES, 
	IMMIGRANT_NO, 
	OCC_MGMT, 
	OCC_BUS_FIN_AD, 
	OCC_NAT_APP_SCI, 
	OCC_HLTH, 
	OCC_SOCI_SERV, 
	OCC_ART_CUL_REC, 
	OCC_SALE_SERV, 
	OCC_TRADES, 
	OCC_NAT_RSRC, 
	OCC_MAN_UTIL, 
	EDUC_NONE, 
	EDUC_HIGHSCH, 
	EDUC_POSTSEC, 
	EDUC_COLLEGE, 
	EDUC_BACHELOR, 
	EDUC_TRADES, 
	EDUC_CRT_ABV_BACH, 
	EDUC_MEDICAL, 
	EDUC_MASTERS, 
	EDUC_PHD, 
	MAJOR_EDUC, 
	MAJOR_ART_COM, 
	MAJOR_HUMANITIES, 
	MAJOR_SOC_SCI, 
	MAJOR_BUS_MGT, 
	MAJOR_PHY_SCI, 
	MAJOR_MATH_COMP, 
	MAJOR_ENGR, 
	MAJOR_NAT_RSRC, 
	MAJOR_HLTH, 
	MAJOR_SERVICES, 
	IN_LAB_FORCE_YES, 
	IN_LAB_FORCE_NO, 
	HOME_SUITABLE_YES, 
	HOME_SUITABLE_NO, 
	REPAIRS_MINOR, 
	REPAIRS_MAJOR, 
	HOME_OWN_OWN, 
	HOME_OWN_RENT, 
	HOME_OWN_BAND, 
	LANG_KNOW_EN, 
	LANG_KNOW_FR, 
	LANG_KNOW_BOTH, 
	LANG_KNOW_NONE, 
	LANG_SPOKE_EN, 
	LANG_SPOKE_FR, 
	LANG_SPOKE_BOTH, 
	LANG_SPOKE_NONE, 
	GO_TO_WORK_5AM_7AM, 
	GO_TO_WORK_7AM_9AM, 
	GO_TO_WORK_AFTER_9AM, 
	INC_BT_IND_MED, 
	INC_BT_IND_AVG, 
	INC_BT_FAM_MED, 
	INC_BT_FAM_AVG, 
	INC_AT_FAM_MED, 
	INC_AT_FAM_AVG, 
	INC_BT_HHS_MED, 
	INC_BT_HHS_AVG, 
	INC_AT_LONE_PARENT_AVG, 
	INC_AT_CPL_W_CHILD_AVG, 
	INC_AT_LONE_PARENT_MED, 
	INC_AT_CPL_W_CHILD_MED, 
	LICO_AT_PREVALENCE, 
	LIM_AT_PREVALENCE, 
	LABOUR_PART_RT, 
	LABOUR_EMPL_RT, 
	LABOUR_UNEM_RT, 
	HOME_VALUE_AVG, 
	HOME_VALUE_MED, 
	HOME_COST_OWN, 
	HOME_RENT_AVG, 
	HOME_RENT_MED, 
	SUBSIDIZED_HOUS, 
	POSTAL_CODE, 
	REGION, 
	SD, 
	LATITUDE, 
	LONGITUDE


```{r}
data_imputed_2021_append = data_imputed_2021 %>% 
  select(
    DA_ID, 
	CSD_UID, 
	CD_UID, 
	CENSUS_YEAR, 
	POP_DENSITY, 
	AGE_GRP_00_04, 
	AGE_GRP_05_09, 
	AGE_GRP_10_14, 
	AGE_GRP_15_19, 
	AGE_GRP_20_24, 
	AGE_GRP_25_29, 
	AGE_GRP_30_34, 
	AGE_GRP_35_39, 
	AGE_GRP_40_44, 
	AGE_GRP_45_49, 
	AGE_GRP_50_54, 
	AGE_GRP_55_59, 
	AGE_GRP_60_64, 
	AGE_GRP_65_PLUS, 
	DWELL_HOUS, 
	DWELL_APT_LRG, 
	DWELL_APT_SML, 
	DWELL_MOVE, 
	MARITAL_MARR, 
	MARITAL_NEVER, 
	MARITAL_SEP, 
	MARITAL_DIV, 
	MARITAL_WID, 
	FAM_SIZE_2, 
	FAM_SIZE_3, 
	FAM_SIZE_4, 
	FAM_SIZE_5, 
	SING_PARENT_F, 
	SING_PARENT_M, 
	COUPLES_CHILD_Y, 
	COUPLES_CHILD_N, 
	INC_FAM_TOP, 
	INC_FAM_BOTTOM, 
	INC_FAM_DEC_10, 
	INC_HHS_100K_125K, 
	INC_HHS_125K_150K, 
	INC_HHS_150K_PLUS, 
	ABORIGINAL_YES, 
	ABORIGINAL_NO, 
	REG_INDIAN_YES, 
	REG_INDIAN_NO, 
	MINORITY_YES, 
	MINORITY_NO, 
	CITIZEN_CAN, 
	CITIZEN_NOT_CAN, 
	IMMIGRANT_YES, 
	IMMIGRANT_NO, 
	OCC_MGMT, 
	OCC_BUS_FIN_AD, 
	OCC_NAT_APP_SCI, 
	OCC_HLTH, 
	OCC_SOCI_SERV, 
	OCC_ART_CUL_REC, 
	OCC_SALE_SERV, 
	OCC_TRADES, 
	OCC_NAT_RSRC, 
	OCC_MAN_UTIL, 
	EDUC_NONE, 
	EDUC_HIGHSCH, 
	EDUC_POSTSEC, 
	EDUC_COLLEGE, 
	EDUC_BACHELOR, 
	EDUC_TRADES, 
	EDUC_CRT_ABV_BACH, 
	EDUC_MEDICAL, 
	EDUC_MASTERS, 
	EDUC_PHD, 
	MAJOR_EDUC, 
	MAJOR_ART_COM, 
	MAJOR_HUMANITIES, 
	MAJOR_SOC_SCI, 
	MAJOR_BUS_MGT, 
	MAJOR_PHY_SCI, 
	MAJOR_MATH_COMP, 
	MAJOR_ENGR, 
	MAJOR_NAT_RSRC, 
	MAJOR_HLTH, 
	MAJOR_SERVICES, 
	IN_LAB_FORCE_YES, 
	IN_LAB_FORCE_NO, 
	HOME_SUITABLE_YES, 
	HOME_SUITABLE_NO, 
	REPAIRS_MINOR, 
	REPAIRS_MAJOR, 
	HOME_OWN_OWN, 
	HOME_OWN_RENT, 
	HOME_OWN_BAND, 
	LANG_KNOW_EN, 
	LANG_KNOW_FR, 
	LANG_KNOW_BOTH, 
	LANG_KNOW_NONE, 
	LANG_SPOKE_EN, 
	LANG_SPOKE_FR, 
	LANG_SPOKE_BOTH, 
	LANG_SPOKE_NONE, 
	GO_TO_WORK_5AM_7AM, 
	GO_TO_WORK_7AM_9AM, 
	GO_TO_WORK_AFTER_9AM, 
	INC_BT_IND_MED, 
	INC_BT_IND_AVG, 
	INC_BT_FAM_MED, 
	INC_BT_FAM_AVG, 
	INC_AT_FAM_MED, 
	INC_AT_FAM_AVG, 
	INC_BT_HHS_MED, 
	INC_BT_HHS_AVG, 
	INC_AT_LONE_PARENT_AVG, 
	INC_AT_CPL_W_CHILD_AVG, 
	INC_AT_LONE_PARENT_MED, 
	INC_AT_CPL_W_CHILD_MED, 
	LICO_AT_PREVALENCE, 
	LIM_AT_PREVALENCE, 
	LABOUR_PART_RT, 
	LABOUR_EMPL_RT, 
	LABOUR_UNEM_RT, 
	HOME_VALUE_AVG, 
	HOME_VALUE_MED, 
	HOME_COST_OWN, 
	HOME_RENT_AVG, 
	HOME_RENT_MED, 
	SUBSIDIZED_HOUS
  ) 




# new_tmf_2021 =  read_csv("K:/15000-40 Development/2023/20230001jd - TMF 202301/POSTALCODES_GEOCODED_202209.csv")  
new_tmf_2021 = read_csv("K:/15000-40 Development/2023/20230001jd - TMF 202301/gcs_results.csv")
new_tmf_2021 %>% glimpse()
# Pick up the field from TMF
new_tmf_2021 = new_tmf_2021 %>% mutate(
  DA_ID = paste0("59",
                 str_pad(CD_2021, width = 2, side = "left", pad = "0"),
                 str_pad(DA_2021, width = 4, side = "left", pad = "0") )
) 

new_tmf_2021 = new_tmf_2021 %>% 
  filter(!is.na(DA_2021))
# verify the REGION is the MUN_NAME
# %>% 
  # filter(REGION == 'Mount Waddington D') 

# Join two table together

data_imputed_2021_postal_code_append = data_imputed_2021_append %>% 
  mutate(DA_ID = as.character(DA_ID)) %>% # previously in order to do the imputation, DA_ID is converted to numeric variable. Now to join to TMF. We need to convert it back to character
  left_join(
    
    new_tmf_2021 %>%
  select(
    DA_ID,
    POSTAL_CODE = POSTALCODE,
    REGION = MUN_NAME_2021,
    SD,
    LATITUDE,
    LONGITUDE
  ) ,
  by = c("DA_ID")
    
  ) %>% 
  mutate(
        SD = str_pad(SD, width = 2, side = "left", pad = "0"),
    LATITUDE = as.character(LATITUDE),
    LONGITUDE = as.character(LONGITUDE)
  )

data_imputed_2021_postal_code_append %>% 
  glimpse()

data_imputed_2021 %>%
  group_by(CENSUS_YEAR) %>% 
  summarise(
    across(
      .cols = c(INC_BT_FAM_AVG, INC_BT_FAM_MED, INC_AT_FAM_AVG, INC_AT_FAM_MED),
      .fns = ~mean(.x, na.rm = T)
    )
  )

data_imputed_2021_postal_code_append %>%
  group_by(CENSUS_YEAR) %>% 
  summarise(
    across(
      .cols = c(INC_BT_FAM_AVG, INC_BT_FAM_MED, INC_AT_FAM_AVG, INC_AT_FAM_MED),
      .fns = ~mean(.x, na.rm = T)
    )
  )



# append to table: ECON_CENSUS_ALL_YRS_POSTAL_CODES_IMP

source("c:/app/r/r_utility.r")
con=connect_edw("edw")

dbExecute(con, "DELETE FROM ECON_CENSUS_ALL_YRS_POSTAL_CODES_IMP WHERE CENSUS_YEAR = 2021")
# dbRemoveTable(con, name = "TRANSLATION_MASTER_SEP_2022_CENCUS2021")
# dbCreateTable(con, name = "TRANSLATION_MASTER_SEP_2022_CENCUS2021",  fields = head(new_tmf_2021, 0))
# dbReadTable(con, name = "TRANSLATION_MASTER_SEP_2022_CENCUS2021")
# 0 row, only has column names
# If there is a date field, we need to convert it to string as.character()
dbAppendTable(con, name = "ECON_CENSUS_ALL_YRS_POSTAL_CODES_IMP", value = data_imputed_2021_postal_code_append)


# library(tidyverse)
# data_imputed_knn_2021 %>% 
#   filter(POSTAL_CODE == 'V3W6K8') %>% 
#   glimpse()
```

